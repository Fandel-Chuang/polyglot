# polyglot å¾ªç¯å¼•ç”¨è§£å†³æ–¹æ¡ˆè¯¦è§£

## ğŸ”´ é—®é¢˜åœºæ™¯ï¼šå¾ªç¯å¼•ç”¨

### åŸå§‹ä»£ç ç»“æ„ï¼ˆæœ‰é—®é¢˜ï¼‰
```
é¡¹ç›®ç»“æ„ï¼š
â”œâ”€â”€ player.pg
â”œâ”€â”€ enemy.pg
â””â”€â”€ main.pg
```

#### player.pg
```rust
// âŒ é—®é¢˜ä»£ç 
import "enemy"

struct Player {
    id: i32,
    health: f32,
    position: Vector3,
    target_enemy: Enemy  // ç›´æ¥å¼•ç”¨Enemyç±»å‹
}

func player_attack(player: Player, enemy: Enemy) -> f32 {
    return calculate_damage(player.attack_power, enemy.defense)
}
```

#### enemy.pg
```rust
// âŒ é—®é¢˜ä»£ç 
import "player"  // è¿™é‡Œå½¢æˆäº†å¾ªç¯ï¼šplayer.pg â†’ enemy.pg â†’ player.pg

struct Enemy {
    id: i32,
    health: f32,
    position: Vector3,
    target_player: Player  // ç›´æ¥å¼•ç”¨Playerç±»å‹
}

func enemy_attack(enemy: Enemy, player: Player) -> f32 {
    return calculate_damage(enemy.attack_power, player.defense)
}
```

### ä¾èµ–å›¾ï¼ˆæœ‰é—®é¢˜ï¼‰
```
player.pg â”€â”€â”€â”€â”€â”€â†’ enemy.pg
    â†‘                 â”‚
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿™å½¢æˆäº†ä¸€ä¸ªç¯ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®šå…ˆç¼–è¯‘å“ªä¸ªæ–‡ä»¶ï¼
```

---

## âœ… è§£å†³æ–¹æ¡ˆ 1ï¼šæå–å…¬å…±æ¨¡å—

### é‡æ„åçš„ä»£ç ç»“æ„
```
é¡¹ç›®ç»“æ„ï¼š
â”œâ”€â”€ common.pg        # æ–°å¢ï¼šå…¬å…±å®šä¹‰
â”œâ”€â”€ player.pg        # é‡æ„ï¼šåªä¾èµ–common
â”œâ”€â”€ enemy.pg         # é‡æ„ï¼šåªä¾èµ–common
â””â”€â”€ main.pg
```

#### common.pgï¼ˆæ–°å»ºï¼‰
```rust
// âœ… å…¬å…±å®šä¹‰æ–‡ä»¶
// æ‰€æœ‰å…±åŒéœ€è¦çš„ç±»å‹å’Œå‡½æ•°éƒ½æ”¾åœ¨è¿™é‡Œ

// åŸºç¡€æ•°æ®ç±»å‹
@ Vector3 {
    x: f32,
    y: f32,
    z: f32
}

@ EntityId {
    value: i32
}

// æ¸¸æˆå®ä½“çš„é€šç”¨æ¥å£
% GameEntity {
    func get_id() -> EntityId
    func get_position() -> Vector3
    func get_health() -> f32
    func take_damage(damage: f32)
}

// å…¬å…±çš„æˆ˜æ–—è®¡ç®—å‡½æ•°
func calculate_damage(attack_power: f32, defense: f32) -> f32 {
    let base_damage = attack_power - defense
    if base_damage < 0 {
        return 0.0
    }
    return base_damage
}

// è·ç¦»è®¡ç®—
func calculate_distance(pos1: Vector3, pos2: Vector3) -> f32 {
    let dx = pos1.x - pos2.x
    let dy = pos1.y - pos2.y
    let dz = pos1.z - pos2.z
    return sqrt(dx*dx + dy*dy + dz*dz)
}
```

#### player.pgï¼ˆé‡æ„åï¼‰
```rust
// âœ… é‡æ„åçš„player.pg
import "common"  // åªå¯¼å…¥commonï¼Œä¸å¯¼å…¥enemy

struct Player {
    id: EntityId,
    health: f32,
    position: Vector3,
    attack_power: f32,
    defense: f32,
    target_enemy_id: EntityId  // ç”¨IDå¼•ç”¨ï¼Œè€Œä¸æ˜¯ç›´æ¥å¼•ç”¨Enemyå¯¹è±¡
}

// å®ç°å…¬å…±æ¥å£
impl GameEntity for Player {
    func get_id() -> EntityId {
        return self.id
    }

    func get_position() -> Vector3 {
        return self.position
    }

    func get_health() -> f32 {
        return self.health
    }

    func take_damage(damage: f32) {
        self.health -= damage
        if self.health < 0 {
            self.health = 0
        }
    }
}

// ç©å®¶ç‰¹æœ‰çš„åŠŸèƒ½
func player_move_to(player: Player, target: Vector3) {
    player.position = target
}

func player_set_target(player: Player, enemy_id: EntityId) {
    player.target_enemy_id = enemy_id
}
```

#### enemy.pgï¼ˆé‡æ„åï¼‰
```rust
// âœ… é‡æ„åçš„enemy.pg
import "common"  // åªå¯¼å…¥commonï¼Œä¸å¯¼å…¥player

struct Enemy {
    id: EntityId,
    health: f32,
    position: Vector3,
    attack_power: f32,
    defense: f32,
    target_player_id: EntityId  // ç”¨IDå¼•ç”¨ï¼Œè€Œä¸æ˜¯ç›´æ¥å¼•ç”¨Playerå¯¹è±¡
}

// å®ç°å…¬å…±æ¥å£
impl GameEntity for Enemy {
    func get_id() -> EntityId {
        return self.id
    }

    func get_position() -> Vector3 {
        return self.position
    }

    func get_health() -> f32 {
        return self.health
    }

    func take_damage(damage: f32) {
        self.health -= damage
        if self.health < 0 {
            self.health = 0
        }
    }
}

// æ•Œäººç‰¹æœ‰çš„åŠŸèƒ½
func enemy_patrol(enemy: Enemy, waypoints: []Vector3) {
    // å·¡é€»é€»è¾‘
}

func enemy_set_target(enemy: Enemy, player_id: EntityId) {
    enemy.target_player_id = player_id
}
```

#### main.pgï¼ˆä½¿ç”¨ç¤ºä¾‹ï¼‰
```rust
// âœ… ä¸»ç¨‹åºï¼šåè°ƒplayerå’Œenemyçš„äº¤äº’
import "common"
import "player"
import "enemy"

func main() {
    // åˆ›å»ºæ¸¸æˆå®ä½“
    let player1 = Player {
        id: EntityId { value: 1 },
        health: 100.0,
        position: Vector3 { x: 0.0, y: 0.0, z: 0.0 },
        attack_power: 25.0,
        defense: 5.0,
        target_enemy_id: EntityId { value: 0 }
    }

    let enemy1 = Enemy {
        id: EntityId { value: 2 },
        health: 80.0,
        position: Vector3 { x: 10.0, y: 0.0, z: 0.0 },
        attack_power: 20.0,
        defense: 3.0,
        target_player_id: EntityId { value: 1 }
    }

    // è®¡ç®—æˆ˜æ–—ç»“æœ
    let distance = calculate_distance(player1.get_position(), enemy1.get_position())
    if distance < 5.0 {  // åœ¨æ”»å‡»èŒƒå›´å†…
        let damage_to_enemy = calculate_damage(player1.attack_power, enemy1.defense)
        enemy1.take_damage(damage_to_enemy)

        let damage_to_player = calculate_damage(enemy1.attack_power, player1.defense)
        player1.take_damage(damage_to_player)
    }
}
```

### é‡æ„åçš„ä¾èµ–å›¾ï¼ˆæ— å¾ªç¯ï¼‰
```
           common.pg
          â•±         â•²
         â•±           â•²
    player.pg    enemy.pg
         â•²           â•±
          â•²         â•±
           main.pg

è¿™æ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾(DAG)ï¼Œç¼–è¯‘å™¨å¯ä»¥æŒ‰ä»¥ä¸‹é¡ºåºç¼–è¯‘ï¼š
1. common.pg
2. player.pg å’Œ enemy.pgï¼ˆå¯ä»¥å¹¶è¡Œç¼–è¯‘ï¼‰
3. main.pg
```

---

## âœ… è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æ¥å£å’Œå·¥å‚æ¨¡å¼

### æ›´é«˜çº§çš„è§£å†³æ–¹æ¡ˆ
```rust
// common.pg
interface Combatant {
    func get_attack_power() -> f32
    func get_defense() -> f32
    func take_damage(amount: f32)
    func is_alive() -> bool
}

// æˆ˜æ–—ç³»ç»Ÿï¼ˆä¸ä¾èµ–å…·ä½“ç±»å‹ï¼‰
func combat_round(attacker: Combatant, defender: Combatant) -> bool {
    if !attacker.is_alive() || !defender.is_alive() {
        return false
    }

    let damage = calculate_damage(attacker.get_attack_power(), defender.get_defense())
    defender.take_damage(damage)
    return true
}
```

---

## ğŸ” ç¼–è¯‘å™¨çš„æ£€æµ‹è¿‡ç¨‹

### ç¼–è¯‘å™¨å¦‚ä½•æ£€æµ‹å¾ªç¯å¼•ç”¨
```
1. æ‰«ææ‰€æœ‰.pgæ–‡ä»¶ï¼Œæå–importè¯­å¥
2. æ„å»ºæ¨¡å—ä¾èµ–å›¾ï¼š
   player.pg â†’ [enemy.pg]
   enemy.pg â†’ [player.pg]

3. ä½¿ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢(DFS)æ£€æµ‹ç¯ï¼š
   å¼€å§‹è®¿é—® player.pg
   â†’ è®¿é—® enemy.pg
   â†’ å°è¯•è®¿é—® player.pgï¼ˆå‘ç°å·²åœ¨è®¿é—®æ ˆä¸­ï¼‰
   â†’ æ£€æµ‹åˆ°ç¯ï¼

4. æŠ¥å‘Šé”™è¯¯å’Œè§£å†³å»ºè®®
```

### ç¼–è¯‘å™¨çš„å‹å¥½é”™è¯¯æç¤º
```
ç¼–è¯‘é”™è¯¯ï¼šæ£€æµ‹åˆ°å¾ªç¯å¼•ç”¨

å¾ªç¯è·¯å¾„ï¼š
player.pg â†’ enemy.pg â†’ player.pg

é—®é¢˜åˆ†æï¼š
- player.pg çš„ç¬¬3è¡Œå¯¼å…¥äº† enemy.pg
- enemy.pg çš„ç¬¬2è¡Œå¯¼å…¥äº† player.pg
- è¿™å½¢æˆäº†å¾ªç¯ä¾èµ–ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®šç¼–è¯‘é¡ºåº

å»ºè®®è§£å†³æ–¹æ¡ˆï¼š
âœ… æ–¹æ¡ˆ1ï¼šæå–å…¬å…±æ¨¡å—
  åˆ›å»º common.pg å­˜æ”¾ Vector3, EntityId ç­‰å…±åŒç±»å‹
  è®© player.pg å’Œ enemy.pg éƒ½åªå¯¼å…¥ common.pg

âœ… æ–¹æ¡ˆ2ï¼šä½¿ç”¨IDå¼•ç”¨
  ç”¨ enemy_id: i32 ä»£æ›¿ enemy: Enemy
  åœ¨éœ€è¦æ—¶é€šè¿‡æ¸¸æˆç³»ç»ŸæŸ¥æ‰¾å¯¹åº”å¯¹è±¡

âœ… æ–¹æ¡ˆ3ï¼šé‡æ–°è®¾è®¡æ¶æ„
  è€ƒè™‘æ˜¯å¦çœŸçš„éœ€è¦ç›¸äº’å¼•ç”¨
  å¯èƒ½å­˜åœ¨æ›´å¥½çš„è®¾è®¡æ¨¡å¼

è¯¦ç»†æ–‡æ¡£ï¼šhttps://polyglot-lang.org/docs/circular-dependency
```

è¿™ç§è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**å°†ç›¸äº’ä¾èµ–çš„éƒ¨åˆ†æå–åˆ°ä¸€ä¸ªå…¬å…±æ¨¡å—ä¸­ï¼Œè®©åŸæœ¬ç›¸äº’ä¾èµ–çš„æ¨¡å—éƒ½ä¾èµ–è¿™ä¸ªå…¬å…±æ¨¡å—ï¼Œä»è€Œæ‰“ç ´å¾ªç¯**