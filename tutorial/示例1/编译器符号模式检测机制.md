# polyglot 编译器符号模式检测机制

## 🔍 概述

polyglot 编译器具有智能的符号模式检测功能，能够自动识别源代码文件使用的是半角符号还是全角符号模式，并强制整个文件保持符号一致性。这一设计确保了代码的清晰性和可维护性。

## 🎯 设计目标

1. **一致性保证** - 避免同一文件内符号风格混乱
2. **可读性提升** - 统一的符号风格使代码更易阅读
3. **维护便利** - 减少因符号不一致导致的维护问题
4. **团队协作** - 强制团队内保持统一的代码风格
5. **错误预防** - 在编译阶段就发现符号不一致问题

## 📋 检测机制

### 🔬 模式识别流程

编译器按以下步骤进行符号模式检测：

1. **词法分析阶段** - 扫描源代码文件的所有token
2. **关键符号检测** - 识别关键的语法符号
3. **模式确定** - 根据首个关键符号确定整个文件的模式
4. **一致性验证** - 验证后续所有符号是否符合已确定的模式
5. **错误报告** - 发现不一致时生成详细的错误信息

### 🎯 关键检测符号

编译器主要检测以下关键符号来确定模式：

| 功能 | 半角符号 | 全角符号 | 优先级 |
|------|----------|----------|---------|
| 输出语句 | `>>` | `》》` | 高 |
| 变量声明 | `?` | `？` | 高 |
| 返回语句 | `<-` | `＜－` | 高 |
| 函数返回类型 | `->` | `－》` | 高 |
| 结构定义 | `@` | `＠` | 中 |
| 实现块 | `&` | `＆` | 中 |
| 接口定义 | `%` | `％` | 中 |
| 枚举定义 | `#` | `＃` | 中 |
| 赋值操作 | `=` | `＝` | 低 |
| 比较操作 | `==`, `!=` | `＝＝`, `！＝` | 低 |

### 🚦 检测逻辑

```text
开始解析文件
    ↓
扫描第一个关键符号
    ↓
确定符号模式 (半角/全角)
    ↓
锁定模式，继续解析
    ↓
检查每个后续符号
    ↓
符号匹配模式？
    ├─ 是 → 继续解析
    └─ 否 → 生成错误信息，停止编译
```

## ✅ 正确使用示例

### 半角模式文件示例

```polyglot
// 文件：student_management.pg
// 模式：半角符号

@ Student {
    name: s,
    age: i,
    grade: f
}

& Student {
    Student(name: s, age: i, grade: f) {
        <- Student { name: name, age: age, grade: grade }
    }

    show_info() {
        >>("学生姓名: " + _.name)
        >>("年龄: " + _.age)
        >>("成绩: " + _.grade)
    }

    is_adult() -> b {
        <- _.age >= 18
    }
}

main() {
    ? student = Student("张三", 20, 85.5)
    student.show_info()

    (student.is_adult()) ? {
        >>("这是成年学生")
    } : {
        >>("这是未成年学生")
    }

    <- 0
}
```

### 全角模式文件示例

```polyglot
// 文件：学生管理.pg
// 模式：全角符号

＠ 学生 ｛
    姓名： 字符串，
    年龄： 整数，
    成绩： 浮点数
｝

＆ 学生 ｛
    学生（姓名： 字符串， 年龄： 整数， 成绩： 浮点数） ｛
        ＜－ 学生 ｛ 姓名： 姓名， 年龄： 年龄， 成绩： 成绩 ｝
    ｝

    显示信息（） ｛
        》》（"学生姓名： " ＋ ＿．姓名）
        》》（"年龄： " ＋ ＿．年龄）
        》》（"成绩： " ＋ ＿．成绩）
    ｝

    是否成年（） －》 布尔 ｛
        ＜－ ＿．年龄 》＝ 18
    ｝
｝

主函数（） ｛
    ？ 学生 ＝ 学生（"张三"， 20， 85.5）
    学生．显示信息（）

    （学生．是否成年（））？ ｛
        》》（"这是成年学生"）
    ｝： ｛
        》》（"这是未成年学生"）
    ｝

    ＜－ 0
｝
```

## ❌ 错误使用示例

### 混合模式错误

```polyglot
// 文件：mixed_error.pg - 这会导致编译错误

main() {                    // 半角模式开始
    ? name = "张三"         // ✅ 半角符号
    ? age = 20              // ✅ 半角符号

    》》（"姓名： " ＋ name） // ❌ 编译错误！混用全角符号
    >>("年龄: " + age)      // ✅ 半角符号

    <- 0                    // ✅ 半角符号
}
```

### 编译器错误信息

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  polyglot 编译器错误报告
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

错误类型：符号模式不一致
文件路径：mixed_error.pg
错误位置：第 6 行，第 5 列

详细信息：
  检测到全角输出符号 '》》'，但文件已确定为半角模式

符号模式信息：
  ✓ 确定模式：半角符号 (基于第 1 行的 'main()')
  ❌ 冲突符号：'》》' (全角输出符号)
  📍 冲突位置：第 6 行

修复建议：
  1. 将 '》》' 改为 '>>' 以保持半角模式
  2. 或者将整个文件转换为全角模式

转换命令：
  半角模式：polyglot convert --to-halfwidth mixed_error.pg
  全角模式：polyglot convert --to-fullwidth mixed_error.pg

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 🔧 编译器工具

### 模式检测工具

```bash
# 检查文件的符号模式
polyglot check-mode <文件名>

# 示例输出
$ polyglot check-mode example.pg
文件：example.pg
模式：半角符号
检测依据：第 1 行的 'main()' 符号
符号统计：
  - 半角符号：15 个
  - 全角符号：0 个
  - 一致性：✓ 通过
```

### 模式转换工具

```bash
# 转换为半角模式
polyglot convert --to-halfwidth <输入文件> [输出文件]

# 转换为全角模式
polyglot convert --to-fullwidth <输入文件> [输出文件]

# 批量转换目录
polyglot convert --to-fullwidth --recursive src/

# 转换并备份原文件
polyglot convert --to-fullwidth --backup example.pg
```

### 模式验证工具

```bash
# 验证项目中所有文件的符号一致性
polyglot validate-mode --recursive project/

# 示例输出
$ polyglot validate-mode --recursive src/
正在验证符号模式一致性...

✓ src/main.pg           - 半角模式
✓ src/utils.pg          - 半角模式
❌ src/chinese.pg        - 模式冲突 (第 10 行)
✓ src/lib/core.pg       - 全角模式

发现 1 个文件存在符号模式问题。
```

## 🎯 最佳实践

### 1. 项目级统一

```bash
# 在项目根目录创建 .polyglot 配置文件
echo "symbol_mode: halfwidth" > .polyglot

# 或者使用全角模式
echo "symbol_mode: fullwidth" > .polyglot
```

### 2. 编辑器集成

推荐的编辑器配置：

```json
// VS Code 设置示例
{
  "polyglot.symbolMode": "auto-detect",
  "polyglot.enforceConsistency": true,
  "polyglot.showModeIndicator": true,
  "polyglot.convertOnSave": false
}
```

### 3. 团队协作规范

```yaml
# 团队代码规范文件：team_standards.yml
symbol_mode: halfwidth  # 或 fullwidth
enforcement: strict     # 严格模式
auto_fix: false        # 不自动修复，让开发者明确选择
ci_check: true         # CI/CD 中进行检查
```

### 4. Git 钩子集成

```bash
#!/bin/bash
# pre-commit 钩子示例
echo "检查符号模式一致性..."
polyglot validate-mode --recursive src/
if [ $? -ne 0 ]; then
    echo "发现符号模式不一致，请修复后再提交"
    exit 1
fi
```

## 💡 高级特性

### 1. 智能模式推断

编译器可以基于项目上下文智能推断模式：

```bash
# 基于项目中其他文件推断新文件的模式
polyglot new --infer-mode student.pg

# 输出：
# 检测到项目主要使用全角模式，新文件将采用全角模式
# 已创建：student.pg (全角模式)
```

### 2. 渐进式迁移

```bash
# 支持渐进式从半角迁移到全角
polyglot migrate --progressive --from-halfwidth --to-fullwidth src/

# 会逐个文件转换，保持项目可编译状态
```

### 3. 符号模式分析

```bash
# 生成项目符号使用报告
polyglot analyze-symbols --recursive src/ --output report.html

# 生成详细的符号使用统计和建议
```

## 🔍 技术实现细节

### 词法分析器扩展

```rust
// 伪代码：符号模式检测的实现
enum SymbolMode {
    HalfWidth,
    FullWidth,
    Undetermined,
}

struct ModeDetector {
    current_mode: SymbolMode,
    detection_history: Vec<DetectionPoint>,
}

impl ModeDetector {
    fn detect_symbol(&mut self, token: &Token) -> Result<(), ModeError> {
        let detected_mode = self.classify_symbol(token);

        match self.current_mode {
            SymbolMode::Undetermined => {
                self.current_mode = detected_mode;
                self.record_detection(token);
            },
            mode if mode == detected_mode => {
                // 符号一致，继续
            },
            _ => {
                return Err(ModeError::Inconsistent {
                    expected: self.current_mode,
                    found: detected_mode,
                    location: token.location,
                });
            }
        }
        Ok(())
    }
}
```

## 📊 性能影响

符号模式检测对编译性能的影响微乎其微：

- **额外时间**：< 1% 的编译时间开销
- **内存使用**：< 0.1MB 额外内存占用
- **检测效率**：O(n) 时间复杂度，其中 n 是token数量

## 🌟 总结

polyglot 的符号模式检测机制是一个精心设计的特性，它：

1. **提升代码质量** - 强制符号一致性
2. **改善开发体验** - 及时发现和修复符号问题
3. **支持团队协作** - 统一团队代码风格
4. **保持向后兼容** - 支持现有的半角符号代码
5. **面向未来** - 为更多符号模式扩展留下空间

这一机制使 polyglot 成为真正支持多种编码风格的现代编程语言，同时保持了代码的整洁性和可维护性。