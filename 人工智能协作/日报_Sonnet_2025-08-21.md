# 日报（Sonnet）- 2025-08-21

## 一、今日目标
- 让中文/本地化场景“默认可用”：按文件名语种自动切换，确保中文文件名 + 书名号 “ ” + 全角返回《- 能稳定通过；
- 将中文黄金用例接入 CI，保障 PR 必过；
- 清理编译器中对全角/中文的硬编码，统一由 JSON 驱动。

## 二、已完成
1) 语种检测 + JSON 驱动
- 英文文件名：使用内置 ASCII 符号映射，不加载 JSON；
- 非英文文件名：首次加载 symbol_mapping.json，并在词法前对源码做符号规范化（含 “ ”、《- 等），同时覆盖内存中的 symbolMap。

2) Windows UTF-8 支持
- 命令行参数：使用 CommandLineToArgvW 解析，UTF-16→UTF-8；
- 读文件：Windows 使用 _wfopen 宽路径，解决中文路径/文件名 Illegal byte sequence；
- 控制台：保持 UTF-8 输出。

3) 移除硬编码
- 删除 lexer.cpp 中的“全角符号映射”“中文版类型关键字”“真/假”等硬编码；
- Lexer 新增运行时覆盖接口：OverrideSymbolMap / ClearOverride。

4) 测试与样例
- 新增中文黄金样例（tests/golden/ok）：
  - 打印_中文基础.文达、变量声明_已知类型无需问号.文达、条件/循环/模式匹配（骨架/占位）；
  - 中文文件名_书名号_返回.文达（验证中文书名号与《-）；
- 本地批量验证：tests/golden/ok 下样例运行无异常（AST 解释执行流程）。

5) CI 接入
- 更新 .github/workflows/ci.yml：
  - Linux（gcc）和 Windows（MSVC）双平台编译 + 运行 tests/golden/run_golden.py；
  - 生成并上传测试报告 artifact；
- 保障每次 push/PR 自动验证中文场景（基于 tests/golden/cases）。

6) 版本与分支
- 将 feature/core-tests 的提交按顺序 cherry-pick 到 main，删除 feature/core-tests；
- 发布 v1.0.1-alpha（docs/releases/v1.0.1-alpha.md），推送 tag；
- 关键提交：
  - ci: run golden tests…（e6f5e09）
  - core: improve Windows UTF-8 argv handling…（f0bb480）
  - docs(release): add v1.0.1-alpha release notes（fc861ae）

## 三、测试与验证
- tests/golden/cases 已含 hello_en / hello_zh，CI 可直接跑通；
- 批量扩展到 ai_tests/ 与 stdlib/ 时发现：
  - 多个文件为英文文件名但源码中混用全角符号（如 》、（ ），按策略未加载 JSON → 词法报错；
  - 个别中文文件名样例含“引号变体”未在 JSON string_delimiters.double_quote 命中，仍报 “ 不支持；
- 结论：
  - 需要将代表性中文样例整理进 tests/golden/cases，并统一符号/引号；
  - 或增加“内容兜底规范化”（检测到本地化符号时，即便英文文件名也触发规范化与 JSON）。

## 四、风险与问题
- 历史样例中存在非标准书名号/不同全角变体，未被当前 JSON 捕获；
- 英文文件名 + 全角源码的样例较多，按“文件名语种”严格策略会失败；
- Parser 尚未实现条件/循环/模式匹配的真实解析，当前用例为占位/骨架，后续需要升级。

## 五、明日计划
- 方案评估与实现（择一或组合）：
  1) 内容兜底规范化：扫描源码前若发现已知本地化符号，自动加载 JSON 并规范化（不改变“文件名优先”的主策略）；
  2) 梳理 ai_tests/ 与 stdlib/ 典型中文样例，规范化后迁移为 tests/golden/cases/<中文用例>/（input.文达 + expected.out）；
- 启动 feature/core-parser：实现 B1/B2/B3 的 AST 与解析，推进中文结构体/控制流/三赋值语法可执行；
- 为 README 中文示例补充“常见陷阱说明”（不同引号/全角字符变体的规避方式）。

## 六、需决策/支持
- 是否采用“内容兜底规范化”（更友好）还是继续“文件名语种严格策略”？
- 是否授权我将 ai_tests/ 与 stdlib/ 中 3~5 个代表性中文用例，整理进 tests/golden/cases 并修正 expected.out？

—— Sonnet（主程序负责人）
